<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat Application | ChatPage</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link href="style.css" rel="stylesheet">
    <script>try{Typekit.load({async:true});}catch(e){}</script>
</head>
<body>
  <main class="container justify-center">
    <section class="container justify-center" style="width: 75%;">
      <div class="card container justify-center my-2 " style=" background:black; height: 30px;;">
        <h1 class=" d-flex justify-content-center my-1"
          style="color: white; font-weight:bolder; font-size:large; ">
          Welcome to Airchat
        </h1>
      </div>
      <div>
        <span data-bs-toggle="tooltip" data-bs-placement="top" title="Back to Main Page">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-undo-2  float-start my-2"><path d="M9 14 4 9l5-5"/><path d="M4 9h10.5a5.5 5.5 0 0 1 5.5 5.5v0a5.5 5.5 0 0 1-5.5 5.5H11"/></svg>
        </span>
        <span data-bs-toggle="tooltip" data-bs-placement="top" title="Logout">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
            class="lucide lucide-log-out float-end my-2">
            <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4" />
            <polyline points="16 17 21 12 16 7" />
            <line x1="21" x2="9" y1="12" y2="12" />
          </svg>
        </span>
        <div class="d-flex justify-content-center" style="font-size:x-large;">
          User 1
        </div>
      </div>
      <div class="ChatPage my-2">
        <div class="chat-history chatBox">
          <ul class="m-b-0">
              <li class="clearfix">
                  <div class="message-data text-end">
                      <span class="message-data-time">10:10 AM, Today</span>
                      <img src="https://bootdey.com/img/Content/avatar/avatar7.png" alt="avatar">
                  </div>
                  <div class="message other-message float-end"> Hi Aiden, how are you? How is the project coming along? </div>
              </li>
              <li class="clearfix">
                  <div class="message-data">
                    <img src="https://bootdey.com/img/Content/avatar/avatar7.png" alt="avatar">
                      <span class="message-data-time">10:12 AM, Today</span>
                  </div>
                  <div class="message my-message">Are we meeting today?</div>                                    
              </li>                               
              <li class="clearfix">
                  <div class="message-data">
                    <img src="https://bootdey.com/img/Content/avatar/avatar7.png" alt="avatar">
                      <span class="message-data-time">10:15 AM, Today</span>
                  </div>
                  <div class="message my-message">Project has been already finished and I have results to show you.</div>
              </li>
          </ul>
      </div>
      <footer class="row mb-3 px-4 ">
        <div class="col-sm-10">
        <input type="text" id="message" name="message" placeholder="Type Message ..." class="form-control messagebox">
        </div>
        <span class="input-group-btn col-sm-1">
          <button type="button" class="btn btn-dark submit">Send</button>
        </span>
      </footer>
      </div>
    </section>
  </main>


    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-app.js";
        import {getAuth}  from "https://www.gstatic.com/firebasejs/10.9.0/firebase-auth.js";
        import {getDatabase,ref,set,push,onValue}  from "https://www.gstatic.com/firebasejs/10.9.0/firebase-database.js";
        const firebaseConfig = {
      apiKey: "AIzaSyDPTsWxwpb7aFRe9jE2urmRa5Ep9SxDF_k",
      authDomain: "airchat-65f4c.firebaseapp.com",
      databaseURL: "https://airchat-65f4c-default-rtdb.firebaseio.com/",
      projectId: "airchat-65f4c",
      storageBucket: "airchat-65f4c.appspot.com",
      messagingSenderId: "549237724062",
      appId: "1:549237724062:web:b691d727fc698b87f0fc8f",
      measurementId: "G-J3K53FWW9S"
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase();

    $(window).on('keydown',function(e){
      if(e.which==13){
        sendChat();
        return false;
      }
    })

    $(".submit").on('click',function(){
      sendChat();
    })

    function sendChat(){
      var chat = $(".messagebox").val()
      if($.trim(chat)==""){
        return false;
      }
      insertChatIntoDb(chat);
    }
  
    function insertChatIntoDb(chat){
      push(ref(db,'/chats'),{
        from: localStorage.getItem('loggedIn_user_id'),
        to: localStorage.getItem('chat_user_id'),
        message: chat

      })
    }

    const chatRef = ref(db,"/chats")
    onValue(chatRef,(snapshot)=>{
      var arr=[];
      snapshot.forEach((childSnapshot) => {
        const childData = childSnapshot.val()
        if((childData.from ==localStorage.getItem('loggedIn_user_id') || childData.to == localStorage.getItem('loggedIn_user_id')) || (childData.from ==  localStorage.getItem('chat_user_id') || childData.to ==  localStorage.getItem('chat_user_id'))){
          arr.push(childData);
        }
      });
      showDataOnScreen(arr);
    })

    function showDataOnScreen(chats){
      console.log("hello this function is working")
      $('.chatBox ul').html("");
      for(let chat in chats){
        var from_user_id = chats[chat].from;
        var to_user_id = chats[chat].to;
        var stored_message = chats[chat].message;
        var message_type;
        var bubble;

        if(from_user_id == localStorage.getItem('loggedIn_user_id')){
          message_type = 'sent';
          bubble  = 'my-message';
        }
        else{
          message_type = 'reply';
          bubble = 'other-message';
        }
        $('.chatBox ul').append(
        `<li class="${message_type} clearfix">
          <div class="message-data ${message_type ==='sent'?'text-end':'text-start'}">
              <span class="message-data-time">10:10 AM, Today</span>
              <img src="https://bootdey.com/img/Content/avatar/avatar7.png" alt="avatar">
          </div>
          <div class="message ${bubble==='my-message'? 'my-message float-end':'other-message'}">${stored_message}</div>
       </li>`);
        $('.messagebox').val(null);  
      }

    }

      </script>
</body>
</html>